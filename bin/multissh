#!/bin/bash
# ============================================================
# multissh
# ============================================================
#
# 概要:
#   複数のホストに同時にSSH接続し、tmuxで一括操作を可能にするツール
#
# 用途:
#   複数のサーバーに対して同じコマンドを実行したい場合
#   複数のサーバーを同時に監視・管理したい場合
#
# 機能:
#   - tmuxのペイン分割機能を使用して複数ホストに接続
#   - synchronize-panesモードで全ホストに同じ入力を送信可能
#   - ペインは自動的にタイル状に配置
#
# 依存関係:
#   - tmux
#   - ssh
#
# 使用例:
#   $ multissh 192.168.1.{1-4}                    # IPレンジ指定
#   $ multissh 192.168.1.1 192.168.1.2            # 個別指定
#   $ multissh web{1..3}.example.com              # ホスト名指定
#   $ SESSION_NAME=myservers multissh host1 host2 # セッション名指定
#
# セッション管理:
#   - デフォルトのセッション名: multi-ssh-<timestamp>
#   - 環境変数SESSION_NAMEでカスタマイズ可能
#
# tmux操作:
#   - Ctrl+b :setw synchronize-panes off  # 同期モード解除
#   - Ctrl+b :setw synchronize-panes on   # 同期モード有効化
#   - Ctrl+b d                             # セッションからデタッチ
#
# 元作者: @mikeda
# 編集者: @roamer7038
#
# ============================================================

# 引数チェック
if [ $# = 0 ]; then
	echo "usage: $(basename "$0") <destination>"
	echo "examples: $(basename "$0") 192.168.1.{1-4}"
	echo "          $(basename "$0") 192.168.1.1 192.168.1.2"
	exit 1
fi

# tmuxセッション名の設定
# 環境変数SESSION_NAMEが設定されていればそれを使用
# 未設定の場合は"multi-ssh-<UNIXタイムスタンプ>"を使用
if [ -n "$SESSION_NAME" ]; then
	session=$SESSION_NAME
else
	session=multi-ssh-$(date +%s)
fi

# tmuxウィンドウ名
window=multi-ssh

###########################################################
# tmuxセッションの作成
###########################################################

# 新しいtmuxセッションをバックグラウンドで作成
# -d: デタッチ状態で作成
# -n: ウィンドウ名を指定
# -s: セッション名を指定
tmux new-session -d -n $window -s $session

###########################################################
# 各ホストにSSH接続
###########################################################

# 最初のホストに接続（ペイン分割なし）
tmux send-keys "ssh $1" C-m
shift

# 残りのホストに接続（ペインを分割してから接続）
for i in $*; do
	# 新しいペインを作成（水平または垂直に分割）
	tmux split-window

	# ペインをタイル状に自動配置
	# 1>/dev/null で出力を抑制
	tmux select-layout tiled

	# 新しいペインでSSH接続を実行
	tmux send-keys "ssh $i" C-m
done

###########################################################
# ペインの同期設定とアタッチ
###########################################################

# 最初のペイン（ペイン0）を選択状態にする
tmux select-pane -t 0

# ペインの同期モードを有効化
# これにより、すべてのペインに同じキー入力が送信される
tmux set-window-option synchronize-panes on

# セッションにアタッチして操作可能にする
tmux attach-session -t $session
